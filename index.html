<!DOCTYPE html>
<html>
  <head>
    <title>HashMap の実装ってどうなってるの？</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="https://remarkjs.com/downloads/remark-0.15.0.min.js" type="text/javascript">
    </script>
    <style type="text/css">
    @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
    @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap');

    @page {
      size: 1210px 681px;
      margin: 0
    }
    @media print{
      .remark-slide-scaler{
        width: 100% !important;
        height: 100% !important;
        transform: scale(1) !important;
        top: 0 !important;
        left:0 !important;
      }
    }

    body { 
      font-family: 'Noto Sans JP", sans-serif';
    }
    .remark-code {
      border: 5px silver solid;
      border-radius: 15px;
      font-size: 32px; /* 18px */
      margin: 0 -10px;
    }
    .remark-code, .remark-inline-code {
      font-family: "Source Code Pro", monospace;
      font-optical-sizing: auto;
      font-weight: 600;
      font-style: normal;
    }
    .remark-inline-code {
      /* font-style: italic; */
      text-decoration: underline dotted;
      color: #006;
    }

    .remark-slide-content {
      font-size: 38px; /* 20px */
      padding: 0.5em 2em;
    }
    .remark-slide-content > * {
      margin: 0.25em 0;
    }
    .remark-slide-number {
      display: none; /* ページ番号 */
    }
    .remark-slide-content h1 {
      font-size:58px; /* 55px */
    }
    .remark-slide-content h2 {
      font-size:50px; /* 45px */
    }
    .remark-slide-content h3 {
      font-size:40px; /* 35px */
    }
    .remark-slide-content .highlight {
      color: darkred;
      font-weight: bold;
    }

    .underline {
      text-decoration: underline;
    }

    .dotted .remark-code {
      border: 3px black dotted;
    }
    
    .move {
        animation: anim 0.5s ease-out;
    }
    @keyframes anim {
        0% {
            transform: translateX(300px);
        }
        100% {
            transform: translateX(0px);
        }
    }

    table{
      border-collapse: collapse;
      width: 100%;
      text-align: center;
    }
    thead > tr {
      background-color: #222;
      color: white;
    }
    td, th {
      border: 2px solid #555;
      padding: 0 0.5em;
    }

    hr {
      border: 0;
      border-bottom: 3px dashed #444;
    }

    div.note {
      position: relative;
      padding: 0.1em 0.5em;    
      color: #066e15;
      border-radius: 0 10px 10px 10px;
      background: #e3f5d8;
      margin-top: 72px;
      font-size: 32px;
    }
    div.note > p:first-child {
      position: absolute;
      top: -85px;
      left: 0;
      height: 54px;
      padding: 0 1em;
      color: #fff;
      border-radius: 10px 10px 0 0;
      background: #22ac38;
      font-weight: bold;
    }
    div.note > :nth-child(n + 2) {
      margin: 0.5em auto;
    }

    span.footnote {
      color: #444;
    }

    span.img {
      display: block;
      text-align: center;
    }
    span.array img {
      height: 250px;
    }

    .flex {
      display: flex;
    }
    .flex > * {
      flex: 1;
    }
    .flex > p {
      margin: 0 0;
    }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# HashMap の実装って
# どうなってるの？

&nbsp;  
<img src="img/photo.jpg" width="150px;" style="border-radius: 50%; vertical-align: middle;">

@YujiSoftware

---

# 目次

- HashMap について
- HashMap の実装を理解しよう！
    - new
    - put
    - get
- Java のバージョンごとの実装の違い

本日の資料： https://yuji.software/hashmap/

---

# HashMap って何？


## Map とは

- a

## Hash とは

- b
---

class: center, middle

# HashMap の実装を理解しよう！

---

# 参考にするバージョン

- **Java 6**
    - 2006年12月11日リリース
- このバージョンの理由
  - **シンプルでわかりやすいから**
      - 最新の実装は、最適化によって複雑になっている
      （Java 6 … 512行 / Java 24 … 1704行）
  - 本質的なアルゴリズムは同じ

【 最新との違いは、最後に説明します 】

---

# 説明に使用するコード

- プログラミング言語と登場年を格納

```java
Map<String, Integer> m = 
        new HashMap<String, Integer>();

m.put("Java", 1996);
m.put("Kotlin", 2011);
m.put("Python", 1991);
… 中略 …
m.put("Swift", 2014);

System.out.println(m.get("Kotlin"));
```

---

# new HashMap&amp;lt;String, String&amp;gt;()

- 引数なしの場合、デフォルト値で初期化
  - 初期容量（`capacity`）… 16
      * 指定された値以上の2の倍数（理由は後述）
  - 負荷係数（`loadFactor`） … 0.75
      * この割合を超過したら、再構築が行われる

```java
private Entry[] table = new Entry[16];  // 初期容量
private int size = 0; // データ数
private float loadFactor = 0.75; // 負荷係数
private int threshold = (int)(16 * 0.75); // = 12
private float modCount = 0;  // 同時更新チェック
```

---

# Entry の構造

```java
class Entry<K,V> implements Map.Entry<K,V> {
    K key;
    V value;
    int hash;
    Entry<K,V> next;
}
```

---

# map.put("Java", "1995") の挙動

1. テーブルのどの位置（インデックス）に格納するか決定
2. すでにキーが格納済みかどうかを確認  
  3. 格納済みなら、値を上書き  
  3. 未格納なら、テーブルに格納

---

# どの位置（インデックス）に格納するか

1. ハッシュコードを取得
2. ハッシュを計算（hash メソッド）
3. 格納位置（インデックス）を決定（indexFor メソッド）

```java
int x = "Java".hashCode();
//  ↑ 2301506

int hash = hash(x);
//  ↑ 2190222

int i = indexFor(hash);
//  ↑ 14

```

---

# hash メソッドは indexFor メソッド

- **ビット演算！**
  - （詳細は次ページ）

```java
static int hash(int h) {
  h ^= (h >>> 20) ^ (h >>> 12);
  return h ^ (h >>> 7) ^ (h >>> 4);
}
```

```java
static int indexFor(int h, int length) {
  return h & (length-1);
}
```

---

# indexFor メソッドの解説

- データ格納するインデックス（今回は 0〜15）を決めたい  
  → `key.hashCode() % table.length` を求める？
  - でも、余りを求める計算( `%` )は遅い
- そこで、**テーブルサイズを2の倍数とする**
  - これなら、余りを求める **= 下位ビットを取得する**だけ
  - つまり、AND でマスクするだけ

```java
static int indexFor(int h, int length) {
  return h & (length-1);
}
```

---

# hash メソッドの解説

- `hashCode()` をそのまま使うだけでもよい
- でも、オブジェクトによっては**下位ビットがあまり変化しない実装になっていることがある**
    - Float とか <span class="footnote">（例えば、1.0f と 2.0f で下位ビットが同じ）</span>
- そこで、上位ビットの値を下位ビットに XOR で集める

```java
static int hash(int h) {
  h ^= (h >>> 20) ^ (h >>> 12);
  return h ^ (h >>> 7) ^ (h >>> 4);
}
```
---

# hash の計算

```java
static int hash(int h) {
  h ^= (h >>> 20) ^ (h >>> 12);
  return h ^ (h >>> 7) ^ (h >>> 4);
}
```

---

# ちなみに、Java 8 以降の場合

上位ビット16 ビットを、下位に XOR するだけになった

```java
static int hash(Object key) {
  int h = key.hashCode()
  return h ^ (h >>> 16);
}
```

<table>
  <tr><!-- 10 0011 0001 1110 0100 0010 -->
    <td style="border: none"></td>
    <td style="background-color: aquamarine;">0000</td>
    <td style="background-color: aquamarine;">0000</td>
    <td style="background-color: aquamarine;">0010</td>
    <td style="background-color: aquamarine;">0011</td>
    <td>0001</td>
    <td>1110</td>
    <td>0100</td>
    <td>0010</td>
  </tr>
  <tr></tr>
    <td style="border: none">XOR</td>
    <td>0000</td>
    <td>0000</td>
    <td>0000</td>
    <td>0000</td>
    <td style="background-color: aquamarine;">0000</td>
    <td style="background-color: aquamarine;">0000</td>
    <td style="background-color: aquamarine;">0010</td>
    <td style="background-color: aquamarine;">0011</td>
  </tr>
  <tr style="border-top: double 3px black"></tr>
    <td style="border: none">=</td>
    <td>0000</td>
    <td>0000</td>
    <td>0010</td>
    <td>0011</td>
    <td>0001</td>
    <td>1110</td>
    <td>0110</td>
    <td>0001</td>
  </tr>
</table>


</textarea>
<script type="text/javascript">
  var slideshow = remark.create({
    highlightLines: true,
    highlightStyle: "googlecode",
    ratio: '16:9'
  });
</script>
</body>
</html>