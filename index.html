<!DOCTYPE html>
<html>
  <head>
    <title>HashMap の実装ってどうなってるの？</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="https://remarkjs.com/downloads/remark-0.15.0.min.js" type="text/javascript">
    </script>
    <style type="text/css">
    @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
    @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap');

    @page {
      size: 1210px 681px;
      margin: 0
    }
    @media print{
      .remark-slide-scaler{
        width: 100% !important;
        height: 100% !important;
        transform: scale(1) !important;
        top: 0 !important;
        left:0 !important;
      }
    }

    body { 
      font-family: 'Noto Sans JP", sans-serif';
    }
    .remark-code {
      border: 5px silver double;
      border-radius: 15px;
      font-size: 32px; /* 18px */
      margin: 0 -10px;
      background-color: #F2F2F2 !important;
    }
    .remark-code, .remark-inline-code {
      font-family: "Source Code Pro", monospace;
      font-optical-sizing: auto;
      font-weight: 600;
      font-style: normal;
    }
    .remark-inline-code {
      /* font-style: italic; */
      text-decoration: underline dotted;
      color: #006;
    }

    .remark-slide-content {
      font-size: 38px; /* 20px */
      padding: 0.5em 2em;
    }
    .remark-slide-content > * {
      margin: 0.25em 0;
    }
    .remark-slide-number {
      display: none; /* ページ番号 */
    }
    .remark-slide-content h1 {
      font-size:58px; /* 55px */
    }
    .remark-slide-content h2 {
      font-size:50px; /* 45px */
    }
    .remark-slide-content h3 {
      font-size:40px; /* 35px */
    }
    .remark-slide-content .highlight {
      color: darkred;
      font-weight: bold;
    }

    .underline {
      text-decoration: underline;
    }

    .dotted .remark-code {
      border: 3px black dotted;
    }
    
    .move {
        animation: anim 0.5s ease-out;
    }
    @keyframes anim {
        0% {
            transform: translateX(300px);
        }
        100% {
            transform: translateX(0px);
        }
    }

    table{
      border-collapse: collapse;
      width: 100%;
      text-align: center;
    }
    thead > tr {
      background-color: #222;
      color: white;
    }
    td, th {
      border: 2px solid #555;
      padding: 0 0.5em;
    }

    table.bitmap tr td {
      border: 1px solid #555;
    }

    table.bitmap tr td:nth-child(1) {
      font-size: 32px;
      border: none;
    }

    table.bitmap tr td:nth-child(n+1) {
      font-size: 34px;
      padding: 0px 4px;
      width: 100%;
    }

    table.bitmap tr td:nth-child(4n+1) {
      border-right: 3px double black;
    }

    table.bitmap tr td.cyan {
      background-color: lightcyan;
    }

    table.bitmap tr td.pink {
      background-color: pink;
    }

    table.bitmap tr td.yellow {
      background-color: lemonchiffon;
    }

    table.bitmap tr td.green {
      background-color: palegreen;
    }

    hr {
      border: 0;
      border-bottom: 3px dashed #444;
    }

    div.note {
      position: relative;
      padding: 0.1em 0.5em;    
      color: #066e15;
      border-radius: 0 10px 10px 10px;
      background: #e3f5d8;
      margin-top: 72px;
      font-size: 32px;
    }
    div.note > p:first-child {
      position: absolute;
      top: -85px;
      left: 0;
      height: 54px;
      padding: 0 1em;
      color: #fff;
      border-radius: 10px 10px 0 0;
      background: #22ac38;
      font-weight: bold;
    }
    div.note > :nth-child(n + 2) {
      margin: 0.5em auto;
    }

    span.remark {
      font-size: 32px;
      color: #444;
    }

    span.img {
      display: block;
      text-align: center;
    }
    span.array img {
      height: 250px;
    }

    .flex {
      display: flex;
    }
    .flex > * {
      flex: 1;
    }
    .flex > p {
      margin: 0 0;
    }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# HashMap の実装って
# どうなってるの？

&nbsp;  
<img src="img/photo.jpg" width="150px;" style="border-radius: 50%; vertical-align: middle;">

@YujiSoftware

---

# 目次

- HashMap について
- HashMap の実装を理解しよう！
    - new
    - put
    - get
- Java のバージョンごとの実装の違い
- 効率良く使うためのコツ

本日の資料： https://yuji.software/hashmap/

---

# HashMap って何？


## Map とは

- a

## Hash とは

- b
---

class: center, middle

# HashMap の実装を理解しよう！

---

# 参考にするバージョン

- **Java 6**
    - 2006年12月11日リリース
- このバージョンの理由
  - **シンプルでわかりやすいから**
      - 最新の実装は、最適化によって複雑になっている
      （Java 6 … 512行 / Java 24 … 1704行）
  - 本質的なアルゴリズムは同じ

【 最新との違いは、最後に説明します 】

---

# 説明に使用するコード

「プログラミング言語」と「リリース年」のペアを格納

```java
Map<String, Integer> m = 
        new HashMap<String, Integer>();

m.put("Java", 1995);
m.put("JavaScript", 1995);
m.put("Kotlin", 2011);
… 中略 …

System.out.println(m.get("Java"));
```

---

# new HashMap&amp;lt;String, String&amp;gt;()

- コンストラクタで、フィールド変数の初期化が行われる
- 主なフィールド変数は**4つ**（詳細は次ページ）

```java
Entry[] table;
int size;
float loadFactor;
int threshold;
```

---

# フィールド変数（1）

```java
Entry[] table;
```

- データを保持する配列
- 容量<span class="remark">（配列サイズ）</span>は、コンストラクタの引数で指定できる
  - ただし、**2の乗数に切り上げる**（理由は後述）
  - デフォルトコンストラクタの場合、容量は **16**

<hr>
![table](img/Entry_1.svg)
  
---
# フィールド変数（2）

```java
int size;
```
- 現在、保持しているデータ数

---
# フィールド変数（3）

```java
float loadFactor;
```

- 負荷係数（テーブルを再構築する割合）
  - コンストラクタの引数で指定できる
  - デフォルトコンストラクタの場合、**0.75**

```java
int threshold = (int)(table.length * loadFactor);
```
- しきい値
  - 保持するデータ数がこの値を超過したら、テーブルの容量を2倍にして再構築する

---

# Entry の構造

```java
class Entry<K,V> implements Map.Entry<K,V> {
    K key;
    V value;
    int hash;
    Entry<K,V> next;
}
```

---

# map.put("Java", 1995)

### "Java" に紐付けて 1995 という値を格納する

<hr>

1. テーブルのどの位置（インデックス）に格納するか決定
2. すでに同一のキーが格納済みかどうかを確認  
  3. 格納済みなら、値を上書き  
  3. 未格納なら、テーブルにエントリーを格納

---

# どの位置（インデックス）に格納するか

1. ハッシュコードを取得
2. ハッシュを計算（hash メソッド）
3. 格納位置（インデックス）を決定（indexFor メソッド）

```java
int x = "Java".hashCode();
//  ↑ 2301506

int hash = hash(x);
//  ↑ 2190222

int i = indexFor(hash);
//  ↑ 14

```

---

# hash メソッドは indexFor メソッド

- **ビット演算！**
  - （詳細は次ページ）

```java
static int hash(int h) {
  h ^= (h >>> 20) ^ (h >>> 12);
  return h ^ (h >>> 7) ^ (h >>> 4);
}
```

```java
static int indexFor(int h, int length) {
  return h & (length-1);
}
```

---

# indexFor メソッドの解説

- データを格納するインデックス<span class="remark">（今回は 0〜15）</span>を決める  
  → `key.hashCode() % table.length` を求める？
  - でも、余りを求める計算( `%` )は遅い
- そこで、**テーブル容量を必ず2の乗数とする**
  - これなら、余りを求める **= 下位ビットを取得する**だけ
  - つまり、AND でマスクするだけ

```java
static int indexFor(int h, int length) {
  return h & (length-1);
}
```

---

# hash メソッドの解説

- `hashCode()` をそのまま使うだけでもよい
- でも、オブジェクトによっては**下位ビットがあまり変化しない実装になっていることがある**
    - Float とか <span class="remark">（例えば、1.0f と 2.0f で下位ビットが同じ）</span>
- そこで、上位ビットの値を下位ビットに XOR で集める

```java
static int hash(int h) {
  h ^= (h >>> 20) ^ (h >>> 12);
  return h ^ (h >>> 7) ^ (h >>> 4);
}
```
---

# hash の計算

`"Java".hashCode()` <span class="remark">（= 0x00231E42）
</span>の場合

<table class="bitmap">
  <tr>
    <td>h</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">1</td><td class="cyan">0</td>
    <td class="pink">0</td><td class="pink">0</td><td class="pink">1</td><td class="pink">1</td>
    <td class="pink">0</td><td class="pink">0</td><td class="pink">0</td><td class="pink">1</td>
    <td>1</td><td>1</td><td>1</td><td>0</td>
    <td>0</td><td>1</td><td>0</td><td>0</td>
    <td>0</td><td>0</td><td>1</td><td>0</td>
  </tr>
  <tr>
    <td>h >>> 20</td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td></td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">1</td><td class="cyan">0</td>
  </tr>
  <tr>
    <td>h >>> 12</td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td></td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">1</td><td class="cyan">0</td>
    <td class="pink">0</td><td class="pink">0</td><td class="pink">1</td><td class="pink">1</td>
    <td class="pink">0</td><td class="pink">0</td><td class="pink">0</td><td class="pink">1</td>
  </tr>
  <tr style="border-top: 3px double #555;">
    <td>XOR</td>
    <td>0</td><td>0</td><td>0</td><td>0</td>
    <td>0</td><td>0</td><td>0</td><td>0</td>
    <td>0</td><td>0</td><td>1</td><td>0</td>
    <td>0</td><td>0</td><td>1</td><td>1</td>
    <td>0</td><td>0</td><td>0</td><td>1</td>
    <td>1</td><td>1</td><td>0</td><td>0</td>
    <td>0</td><td>1</td><td>1</td><td>1</td>
    <td>0</td><td>0</td><td>0</td><td>1</td>
  </tr>
</table>
<hr>
<table class="bitmap">
  <tr>
    <td>h</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">1</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">1</td><td class="yellow">1</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td><td class="yellow">1</td>
    <td class="yellow">1</td><td class="yellow">1</td><td class="yellow">0</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="green">1</td><td class="green">1</td><td class="green">1</td>
    <td>0</td><td>0</td><td>0</td><td>1</td>
  </tr>
  <tr>
    <td>h >>> 7</td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">1</td><td class="yellow">0</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">1</td><td class="yellow">1</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">1</td><td class="yellow">1</td>
    <td class="yellow">1</td><td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td>
  </tr>
  <tr>
    <td>h >>> 4</td>
    <td></td><td></td><td></td><td></td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">1</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">1</td><td class="yellow">1</td>
    <td class="yellow">0</td><td class="yellow">0</td><td class="yellow">0</td><td class="yellow">1</td>
    <td class="yellow">1</td><td class="yellow">1</td><td class="yellow">0</td><td class="yellow">0</td>
    <td class="yellow">0</td><td class="green">1</td><td class="green">1</td><td class="green">1</td>
  </tr>
  <tr style="border-top: 3px double #555;">
    <td>XOR</td>
    <td>0</td><td>0</td><td>0</td><td>0</td>
    <td>0</td><td>0</td><td>0</td><td>0</td>
    <td>0</td><td>0</td><td>1</td><td>0</td>
    <td>0</td><td>0</td><td>0</td><td>1</td>
    <td>0</td><td>1</td><td>1</td><td>0</td>
    <td>1</td><td>0</td><td>1</td><td>1</td>
    <td>1</td><td>0</td><td>0</td><td>0</td>
    <td>1</td><td>1</td><td>1</td><td>0</td>
  </tr>
</table>


---

# データの格納

- 先程の計算により **index = 14 に格納する**
  - `table[14] == null` （データはまだない）
- 新たな Entry を作って格納

!["Java"エントリー](img/Entry_2.svg)

---

# map.put("JavaScript", 1995)

### "JavaScript" に紐付けて 1995 という値を格納する

<hr>

1. テーブルのどの位置（インデックス）に格納するか決定  
  → hash = 1331630014, **index = 14**
2. すでに同一のキーが格納済みかどうかを確認
  3. 格納済みなら、値を上書き  
  3. 未格納なら、テーブルにエントリーを格納

---

# すでに index = 14 にデータがある

!["Java"エントリー](img/Entry_2.svg)

- 同一のキーが格納済み？  
  → **hash が一致 & キーの equals の結果が TRUE** かどうか

---
# 未格納なので、エントリーを追加

- table[14] にエントリーを追加
  - すでに登録されているエントリーは、**next に格納**

<hr>
!["Java"エントリー](img/Entry_3.svg)

---

# さらにデータを追加していく

```java
m.put("Kotlin", 2011);
m.put("Python", 1991);
m.put("Ruby", 1995);
m.put("PHP", 1995);
m.put("Go", 2011);
m.put("Rust", 2013);
…
m.put("C", 1972); // 13個目のデータ
```

`threshold (=12)` を超えた！

---

# hash メソッドの変更

上位ビット16 ビットを、下位に XOR するだけになった

```java
static int hash(Object key) {
  int h = key.hashCode()
  return h ^ (h >>> 16);
}
```

`"Java".hashCode()` <span class="remark">（= 0x00231E42）
</span>の場合

<table class="bitmap">
  <tr>
    <td>h</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">1</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">1</td><td class="cyan">1</td>
    <td>0</td><td>0</td><td>0</td><td>1</td>
    <td>1</td><td>1</td><td>1</td><td>0</td>
    <td>0</td><td>1</td><td>0</td><td>0</td>
    <td>0</td><td>0</td><td>1</td><td>0</td>
  </tr>
  <tr>
    <td>h >> 16</td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td></td>
    <td></td><td></td><td></td><td></td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">1</td><td class="cyan">0</td>
    <td class="cyan">0</td><td class="cyan">0</td><td class="cyan">1</td><td class="cyan">1</td>
  </tr>
  <tr style="border-top: 3px double #555;">
    <td>XOR</td>
    <td>0</td><td>0</td><td>0</td><td>0</td>
    <td>0</td><td>0</td><td>0</td><td>0</td>
    <td>0</td><td>0</td><td>1</td><td>0</td>
    <td>0</td><td>0</td><td>1</td><td>1</td>
    <td>0</td><td>0</td><td>0</td><td>1</td>
    <td>1</td><td>1</td><td>1</td><td>0</td>
    <td>0</td><td>1</td><td>1</td><td>0</td>
    <td>0</td><td>0</td><td>0</td><td>1</td>
  </tr>
</table>

</textarea>
<script type="text/javascript">
  var slideshow = remark.create({
    highlightLines: true,
    highlightStyle: "googlecode",
    ratio: '16:9'
  });
</script>
</body>
</html>